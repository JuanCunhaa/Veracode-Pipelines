# APIID e APIKEY nos secrets

name: Veracode Pipeline Scan

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: read
  security-events: write

jobs:
  pipeline-scan-cli:
    runs-on: ubuntu-latest
    env:
      VERACODE_API_KEY_ID: ${{ secrets.VID }}
      VERACODE_API_KEY_SECRET: ${{ secrets.VKEY }}
    steps:
      - name: 🏁 Checkout
        uses: actions/checkout@v4

      - name: 📦 Instalar Veracode CLI
        run: |
          curl -fsS https://tools.veracode.com/veracode-cli/install | sh
          ./veracode version

      - name: 🔍 Pipeline Scan via Veracode CLI
        run: |
          set -euo pipefail
          ZIP="$(find NOME-DA-PASTA-COM-ZIP -maxdepth 1 -type f -name '*.zip' | head -n1)"
          if [ -z "${ZIP:-}" ]; then
            echo "❌ Nenhum .zip encontrado em veracode-out"; exit 1
          fi

          # Executa o Static Scan (usa Pipeline Scan internamente)
          ./veracode static scan "$ZIP" \
            --results-file results.json \
            --summary-output results.txt \
            --fail-on-severity "Very High, High" \
            --verbose